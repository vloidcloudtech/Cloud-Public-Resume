# ============================================================================
# GitHub Actions Workflow: Portfolio Aggregator Deployment
# ============================================================================
# This workflow automatically deploys the Portfolio Aggregator infrastructure
# and application to AWS whenever code is pushed to the main branch.
#
# Workflow Steps:
#   1. Deploy Terraform infrastructure (creates AWS resources)
#   2. Populate AWS Secrets Manager with API keys from GitHub Secrets
#   3. Build and deploy Lambda functions
#   4. Build and deploy React frontend to S3/CloudFront
#
# Required GitHub Secrets (configure in repo settings â†’ Secrets and variables â†’ Actions):
#   - AWS_ACCESS_KEY_ID: AWS IAM user access key
#   - AWS_SECRET_ACCESS_KEY: AWS IAM user secret key
#   - GH_PERSONAL_ACCESS_TOKEN: GitHub Personal Access Token (repo:read scope)
#   - YOUTUBE_API_KEY: YouTube Data API v3 key
#   - ANTHROPIC_API_KEY: Anthropic Claude API key
#   - GH_USERNAME: Your GitHub username
#   - MEDIUM_USERNAME: Your Medium username
#   - YOUTUBE_CHANNEL_ID: Your YouTube channel ID
# ============================================================================

name: Deploy Portfolio Aggregator

# Trigger conditions
on:
  push:
    branches: [main]  # Deploy on push to main
  pull_request:
    branches: [main]  # Run tests on PRs (won't deploy)

# Environment variables available to all jobs
env:
  AWS_REGION: us-east-1
  TF_VAR_github_username: ${{ secrets.GH_USERNAME }}
  TF_VAR_medium_username: ${{ secrets.MEDIUM_USERNAME }}
  TF_VAR_youtube_channel_id: ${{ secrets.YOUTUBE_CHANNEL_ID }}
  TF_VAR_domain_name: "vloidcloudtech.com"
  TF_VAR_route53_zone_id: "Z0393886EJ0V2CL9B9Y0"

# ============================================================================
# Jobs
# ============================================================================

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Deploy Terraform Infrastructure
  # --------------------------------------------------------------------------
  terraform:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    outputs:
      github_secret_name: ${{ steps.tf-output.outputs.github_secret_name }}
      youtube_secret_name: ${{ steps.tf-output.outputs.youtube_secret_name }}
      ai_secret_name: ${{ steps.tf-output.outputs.ai_secret_name }}
      frontend_bucket_name: ${{ steps.tf-output.outputs.frontend_bucket_name }}
      cloudfront_distribution_id: ${{ steps.tf-output.outputs.cloudfront_distribution_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false  # Disable wrapper for clean outputs

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Build Lambda Deployment Packages
        run: |
          cd backend
          echo "Building Lambda deployment packages..."

          # Array of Lambda function directories
          FUNCTIONS=("github_sync" "medium_sync" "youtube_sync" "api_handler")

          for FUNCTION in "${FUNCTIONS[@]}"; do
            echo "Building $FUNCTION..."
            cd lambda_functions/$FUNCTION

            # Create package directory
            mkdir -p package

            # Copy handler only (dependencies are in the shared layer)
            cp handler.py package/

            # Create deployment package
            cd package
            zip -r ../deployment.zip . -q
            cd ..

            # Clean up
            rm -rf package

            echo "âœ“ Built $FUNCTION"
            cd ../..
          done

          # Create Lambda layer for shared code
          echo "Building shared layer..."
          cd shared
          mkdir -p python

          # Install dependencies into python directory
          if [ -f requirements.txt ]; then
            echo "Installing layer dependencies..."
            # Install lightweight packages first
            pip install requests==2.31.0 feedparser==6.0.10 anthropic==0.8.1 -t python/ --quiet

            # Install Google API client with minimal dependencies to reduce size
            pip install google-api-python-client==2.108.0 -t python/ --no-deps --quiet
            pip install google-auth==2.23.4 google-auth-httplib2==0.1.1 httplib2==0.22.0 uritemplate==4.1.1 google-api-core==2.14.0 googleapis-common-protos==1.61.0 protobuf==4.25.1 -t python/ --quiet
          fi

          # Copy shared Python modules
          cp *.py python/

          # Create layer zip
          zip -r ../layer.zip python -q
          rm -rf python
          cd ..

          echo "âœ“ All Lambda functions and layer built successfully!"

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Import Existing Resources
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          cd terraform
          echo "Importing existing resources (if any)..."

          # Import DynamoDB tables
          terraform import module.database.aws_dynamodb_table.github_repos portfolio-aggregator-github-repos-production 2>/dev/null || echo "  github_repos: skipped"
          terraform import module.database.aws_dynamodb_table.medium_posts portfolio-aggregator-medium-posts-production 2>/dev/null || echo "  medium_posts: skipped"
          terraform import module.database.aws_dynamodb_table.youtube_videos portfolio-aggregator-youtube-videos-production 2>/dev/null || echo "  youtube_videos: skipped"
          terraform import module.database.aws_dynamodb_table.sync_metadata portfolio-aggregator-sync-metadata-production 2>/dev/null || echo "  sync_metadata: skipped"

          # Import S3 bucket
          terraform import module.frontend.aws_s3_bucket.frontend portfolio-aggregator-frontend-production 2>/dev/null || echo "  frontend bucket: skipped"

          # Import CloudFront distribution (find existing distribution with the CNAME)
          CLOUDFRONT_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Aliases.Items && contains(Aliases.Items, 'vloidcloudtech.com')].Id | [0]" --output text 2>/dev/null || echo "")
          if [ -n "$CLOUDFRONT_ID" ] && [ "$CLOUDFRONT_ID" != "None" ]; then
            echo "  Found CloudFront distribution: $CLOUDFRONT_ID"
            terraform import module.frontend.aws_cloudfront_distribution.frontend $CLOUDFRONT_ID 2>/dev/null || echo "  cloudfront: skipped"
          else
            echo "  cloudfront: not found, will be created"
          fi

          # Import Route 53 DNS records
          terraform import 'module.frontend.aws_route53_record.frontend' Z0393886EJ0V2CL9B9Y0_vloidcloudtech.com_A 2>/dev/null || echo "  route53 A record (root): skipped"
          terraform import 'module.frontend.aws_route53_record.frontend_www' Z0393886EJ0V2CL9B9Y0_www.vloidcloudtech.com_A 2>/dev/null || echo "  route53 A record (www): skipped"

          # Import IAM roles
          terraform import module.api.aws_iam_role.api_lambda portfolio-aggregator-api-lambda-role-production 2>/dev/null || echo "  api lambda role: skipped"
          terraform import module.sync.aws_iam_role.sync_lambda portfolio-aggregator-sync-lambda-role-production 2>/dev/null || echo "  sync lambda role: skipped"

          # Import Secrets Manager secrets
          terraform import module.secrets.aws_secretsmanager_secret.github_token portfolio-aggregator-github-token-production 2>/dev/null || echo "  github token secret: skipped"
          terraform import module.secrets.aws_secretsmanager_secret.youtube_api_key portfolio-aggregator-youtube-key-production 2>/dev/null || echo "  youtube api key secret: skipped"
          terraform import module.secrets.aws_secretsmanager_secret.ai_api_key portfolio-aggregator-ai-key-production 2>/dev/null || echo "  ai api key secret: skipped"

          # Import CloudWatch Log Groups
          terraform import module.sync.aws_cloudwatch_log_group.github_sync /aws/lambda/portfolio-aggregator-github-sync-production 2>/dev/null || echo "  github sync log group: skipped"
          terraform import module.sync.aws_cloudwatch_log_group.medium_sync /aws/lambda/portfolio-aggregator-medium-sync-production 2>/dev/null || echo "  medium sync log group: skipped"
          terraform import module.sync.aws_cloudwatch_log_group.youtube_sync /aws/lambda/portfolio-aggregator-youtube-sync-production 2>/dev/null || echo "  youtube sync log group: skipped"

          echo "Import complete"

      - name: Update Lambda Function Code
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "Updating Lambda function code with smaller packages..."
          cd backend/lambda_functions

          # Update each function's code directly via AWS CLI
          for func in github_sync medium_sync youtube_sync api_handler; do
            FUNCTION_NAME="portfolio-aggregator-${func/_/-}-production"
            echo "Updating $FUNCTION_NAME..."
            aws lambda update-function-code \
              --function-name "$FUNCTION_NAME" \
              --zip-file "fileb://$func/deployment.zip" \
              2>/dev/null && echo "  âœ“ Updated $FUNCTION_NAME" || echo "  âš  Skipped $FUNCTION_NAME"
          done

          echo "Waiting 5 seconds for updates to complete..."
          sleep 5

      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: |
          cd terraform
          terraform apply -auto-approve

      - name: Get Terraform Outputs
        if: github.ref == 'refs/heads/main'
        id: tf-output
        run: |
          cd terraform
          echo "github_secret_name=$(terraform output -raw github_token_secret_name)" >> $GITHUB_OUTPUT
          echo "youtube_secret_name=$(terraform output -raw youtube_api_key_secret_name)" >> $GITHUB_OUTPUT
          echo "ai_secret_name=$(terraform output -raw ai_api_key_secret_name)" >> $GITHUB_OUTPUT
          echo "frontend_bucket_name=$(terraform output -raw frontend_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT

  # --------------------------------------------------------------------------
  # Job 2: Populate AWS Secrets from GitHub Secrets
  # --------------------------------------------------------------------------
  populate-secrets:
    name: Populate AWS Secrets
    runs-on: ubuntu-latest
    needs: terraform
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update GitHub Token Secret
        run: |
          aws secretsmanager put-secret-value \
            --secret-id ${{ needs.terraform.outputs.github_secret_name }} \
            --secret-string '{"token":"${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}"}'

      - name: Update YouTube API Key Secret
        run: |
          aws secretsmanager put-secret-value \
            --secret-id ${{ needs.terraform.outputs.youtube_secret_name }} \
            --secret-string '{"api_key":"${{ secrets.YOUTUBE_API_KEY }}"}'

      - name: Update Anthropic API Key Secret
        run: |
          aws secretsmanager put-secret-value \
            --secret-id ${{ needs.terraform.outputs.ai_secret_name }} \
            --secret-string '{"api_key":"${{ secrets.ANTHROPIC_API_KEY }}"}'

  # --------------------------------------------------------------------------
  # Job 3: Deploy Backend Lambda Functions
  # --------------------------------------------------------------------------

  deploy-backend:
    name: Deploy Backend Lambda Functions
    runs-on: ubuntu-latest
    needs: [terraform, populate-secrets]  # Wait for secrets to be populated
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and Deploy Lambda Functions
        run: |
          cd backend
          chmod +x deploy.sh
          ./deploy.sh

  # --------------------------------------------------------------------------
  # Job 4: Deploy Frontend to S3/CloudFront
  # --------------------------------------------------------------------------
  deploy-frontend:
    name: Deploy Frontend React App
    runs-on: ubuntu-latest
    needs: [terraform, populate-secrets]  # Wait for infrastructure
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build and Deploy Frontend
        env:
          BUCKET_NAME: ${{ needs.terraform.outputs.frontend_bucket_name }}
          DIST_ID: ${{ needs.terraform.outputs.cloudfront_distribution_id }}
        run: |
          cd frontend

          # Install dependencies
          npm install

          # Build for production
          npm run build

          echo "âœ“ Frontend built successfully!"
          echo ""
          echo "Deploying to S3..."

          # Sync to S3
          aws s3 sync dist/ s3://$BUCKET_NAME --delete

          echo "âœ“ Deployed to S3!"
          echo ""
          echo "Invalidating CloudFront cache..."

          # Create invalidation
          aws cloudfront create-invalidation \
              --distribution-id $DIST_ID \
              --paths "/*"

          echo "âœ“ CloudFront cache invalidated!"
          echo ""
          echo "ðŸš€ Deployment complete!"

# ============================================================================
# End of Workflow
# ============================================================================
# After successful deployment, your portfolio will be live at the CloudFront URL
# Run: cd terraform && terraform output frontend_url
# ============================================================================
